#include <behaviors.dtsi>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/bt.h>

// layers
#define L_DEF   0
#define L_LFT   1
#define L_RGT   2
#define L_TRD   3
#define L_GAM   4
#define L_TAI   5

// redefine to fit width of three
#define TRN     &trans
#define NON     &none
#define KEY     &kp
#define BLU     &bt
#define REP     &key_repeat
#define BTL     &bootloader
#define CAP     &caps_word
#define RES     &kp 0

// redefine to fit width of five
#define BTCLR   BT_CLR
#define BT1     BT_SEL 0
#define BT2     BT_SEL 1
#define BT3     BT_SEL 2
#define BT4     BT_SEL 3
#define BT5     BT_SEL 4
#define VOLUP   C_VOL_UP
#define VOLDN   C_VOL_DN
#define MUTE    K_MUTE
#define PREV    C_PREV
#define NEXT    C_NEXT

// shortcuts
#define UML     &hm LA(U)
#define ESZ     &hm LA(S)
#define UDO     &hm LG(Z)
#define CPY     &hm LG(C)
#define KUT     &hm LG(X)
#define SAV     &hm LG(S)
#define PST     &hm LG(V)
#define FRT     &hm RET
#define FES     &hm ESC
#define FTA     &hm TAB

// home row mods
#define LMS     &hm LSHFT
#define LMC     &hm LCTRL
#define LMA     &hm LALT
#define LMM     &hm LMETA
#define RMS     &hm RSHFT
#define RMC     &hm RCTRL
#define RMA     &hm RALT
#define RMM     &hm RMETA

// layer toggles
#define LM1     &lm L_LFT
#define LM2     &lm L_RGT
#define LM3     &rm L_TRD 0
#define DEF     &to L_DEF

// taipo
#define LTI 13
#define LBI 23
#define LTM 12
#define LBM 22
#define LTR 11
#define LBR 21
#define LTP 10
#define LBP 20
#define LTT 31
#define LBT 30

#define RTI 16
#define RBI 26
#define RTM 17
#define RBM 27
#define RTR 18
#define RBR 28
#define RTP 19
#define RBP 29
#define RTT 32
#define RBT 33

#define MERGE_(a,b)  a##b
#define LABEL_(a) MERGE_(combo_, a)
#define UNIQUE_COMBO LABEL_(__LINE__)

#define BOTH   0
#define TOP    1
#define LEFT   1
#define RIGHT  2
#define BOTTOM 2
#define NONE   3

#define COMBO(KEYPOS, BINDINGS)    \
    UNIQUE_COMBO {                 \
        layers = <L_TAI>;          \
        timeout-ms = <50>;         \
        key-positions = <KEYPOS>;  \
        bindings = <BINDINGS>;     \
    };

/ {
  combos {
    compatible = "zmk,combos";
        COMBO(                LBP, &kp A     )
        COMBO(                RBP, &kp A     )
        COMBO(            LTR LTP, &kp B     )
        COMBO(            RTR RTP, &kp B     )
        COMBO(    LBI     LBR    , &kp C     )
        COMBO(    RBI     RBR    , &kp C     )
        COMBO(    LBI         LBP, &kp D     )
        COMBO(    RBI         RBP, &kp D     )
        COMBO(    LBI            , &kp E     )
        COMBO(    RBI            , &kp E     )
        COMBO(    LTI     LTR    , &kp F     )
        COMBO(    RTI     RTR    , &kp F     )
        COMBO(    LTI         LTP, &kp G     )
        COMBO(    RTI         RTP, &kp G     )
        COMBO(    LBI LBM        , &kp H     )
        COMBO(    RBI RBM        , &kp H     )
        COMBO(    LTI            , &kp I     )
        COMBO(    RTI            , &kp I     )
        COMBO(        LTM     LBP, &kp J     )
        COMBO(        RTM     RBP, &kp J     )
        COMBO(    LTI     LBR    , &kp K     )
        COMBO(    RTI     RBR    , &kp K     )
        COMBO(            LBR LBP, &kp L     )
        COMBO(            RBR RBP, &kp L     )
        COMBO(    LBI         LTP, &kp M     )
        COMBO(    RBI         RTP, &kp M     )
        COMBO(        LTM        , &kp N     )
        COMBO(        RTM        , &kp N     )
        COMBO(            LBR    , &kp O     )
        COMBO(            RBR    , &kp O     )
        COMBO(        LTM LTR    , &kp P     )
        COMBO(        RTM RTR    , &kp P     )
        COMBO(        LBM     LBP, &kp Q     )
        COMBO(        RBM     RBP, &kp Q     )
        COMBO(                LTP, &kp R     )
        COMBO(                RTP, &kp R     )
        COMBO(            LTR    , &kp S     )
        COMBO(            RTR    , &kp S     )
        COMBO(        LBM        , &kp T     )
        COMBO(        RBM        , &kp T     )
        COMBO(        LBM LBR    , &kp U     )
        COMBO(        RBM RBR    , &kp U     )
        COMBO(    LBI     LTR    , &kp V     )
        COMBO(    RBI     RTR    , &kp V     )
        COMBO(    LTI         LBP, &kp W     )
        COMBO(    RTI         RBP, &kp W     )
        COMBO(        LBM     LTP, &kp X     )
        COMBO(        RBM     RTP, &kp X     )
        COMBO(    LTI LTM        , &kp Y     )
        COMBO(    RTI RTM        , &kp Y     )
        COMBO(        LTM     LTP, &kp Z     )
        COMBO(        RTM     RTP, &kp Z     )

        COMBO(LTT             LBP, &kp LS(A) )
        COMBO(RTT             RBP, &kp LS(A) )
        COMBO(LTT         LTR LTP, &kp LS(B) )
        COMBO(RTT         RTR RTP, &kp LS(B) )
        COMBO(LTT LBI     LBR    , &kp LS(C) )
        COMBO(RTT RBI     RBR    , &kp LS(C) )
        COMBO(LTT LBI         LBP, &kp LS(D) )
        COMBO(RTT RBI         RBP, &kp LS(D) )
        COMBO(LTT LBI            , &kp LS(E) )
        COMBO(RTT RBI            , &kp LS(E) )
        COMBO(LTT LTI     LTR    , &kp LS(F) )
        COMBO(RTT RTI     RTR    , &kp LS(F) )
        COMBO(LTT LTI         LTP, &kp LS(G) )
        COMBO(RTT RTI         RTP, &kp LS(G) )
        COMBO(LTT LBI LBM        , &kp LS(H) )
        COMBO(RTT RBI RBM        , &kp LS(H) )
        COMBO(LTT LTI            , &kp LS(I) )
        COMBO(RTT RTI            , &kp LS(I) )
        COMBO(LTT     LTM     LBP, &kp LS(J) )
        COMBO(RTT     RTM     RBP, &kp LS(J) )
        COMBO(LTT LTI     LBR    , &kp LS(K) )
        COMBO(RTT RTI     RBR    , &kp LS(K) )
        COMBO(LTT         LBR LBP, &kp LS(L) )
        COMBO(RTT         RBR RBP, &kp LS(L) )
        COMBO(LTT LBI         LTP, &kp LS(M) )
        COMBO(RTT RBI         RTP, &kp LS(M) )
        COMBO(LTT     LTM        , &kp LS(N) )
        COMBO(RTT     RTM        , &kp LS(N) )
        COMBO(LTT         LBR    , &kp LS(O) )
        COMBO(RTT         RBR    , &kp LS(O) )
        COMBO(LTT     LTM LTR    , &kp LS(P) )
        COMBO(RTT     RTM RTR    , &kp LS(P) )
        COMBO(LTT     LBM     LBP, &kp LS(Q) )
        COMBO(RTT     RBM     RBP, &kp LS(Q) )
        COMBO(LTT             LTP, &kp LS(R) )
        COMBO(RTT             RTP, &kp LS(R) )
        COMBO(LTT         LTR    , &kp LS(S) )
        COMBO(RTT         RTR    , &kp LS(S) )
        COMBO(LTT     LBM        , &kp LS(T) )
        COMBO(RTT     RBM        , &kp LS(T) )
        COMBO(LTT     LBM LBR    , &kp LS(U) )
        COMBO(RTT     RBM RBR    , &kp LS(U) )
        COMBO(LTT LBI     LTR    , &kp LS(V) )
        COMBO(RTT RBI     RTR    , &kp LS(V) )
        COMBO(LTT LTI         LBP, &kp LS(W) )
        COMBO(RTT RTI         RBP, &kp LS(W) )
        COMBO(LTT     LBM     LTP, &kp LS(X) )
        COMBO(RTT     RBM     RTP, &kp LS(X) )
        COMBO(LTT LTI LTM        , &kp LS(Y) )
        COMBO(RTT RTI RTM        , &kp LS(Y) )
        COMBO(LTT     LTM     LTP, &kp LS(Z) )
        COMBO(RTT     RTM     RTP, &kp LS(Z) )

        COMBO(LBT                , &kp BSPC  )
        COMBO(RBT                , &kp BSPC  )
        COMBO(LTT                , &kp SPC   )
        COMBO(RTT                , &kp SPC   )

        COMBO(LBT LBI LBM        , &kp N0    )
        COMBO(RBT RBI RBM        , &kp N0    )
        COMBO(LBT LBI     LBR    , &kp N1    )
        COMBO(RBT RBI     RBR    , &kp N1    )
        COMBO(LBT     LBM LBR    , &kp N2    )
        COMBO(RBT     RBM RBR    , &kp N2    )
        COMBO(LBT     LBM     LBP, &kp N3    )
        COMBO(RBT     RBM     RBP, &kp N3    )
        COMBO(LBT         LBR LBP, &kp N4    )
        COMBO(RBT         RBR RBP, &kp N4    )
        COMBO(LBT LTI LTM        , &kp N5    )
        COMBO(RBT RTI RTM        , &kp N5    )
        COMBO(LBT LTI     LTR    , &kp N6    )
        COMBO(RBT RTI     RTR    , &kp N6    )
        COMBO(LBT     LTM LTR    , &kp N7    )
        COMBO(RBT     RTM RTR    , &kp N7    )
        COMBO(LBT     LTM     LTP, &kp N8    )
        COMBO(RBT     RTM     RTP, &kp N8    )
        COMBO(LBT         LTR LTP, &kp N9    )
        COMBO(RBT         RTR RTP, &kp N9    )

        COMBO(LBT LBI            , &kp LPAR  )
        COMBO(RBT RBI            , &kp LPAR  )
        COMBO(LBT LTI            , &kp RPAR  )
        COMBO(RBT RTI            , &kp RPAR  )
        COMBO(LBT     LBM        , &kp LBKT  )
        COMBO(RBT     RBM        , &kp LBKT  )
        COMBO(LBT     LTM        , &kp RBKT  )
        COMBO(RBT     RTM        , &kp RBKT  )
        COMBO(LBT         LBR    , &kp LBRC  )
        COMBO(RBT         RBR    , &kp LBRC  )
        COMBO(LBT         LTR    , &kp RBRC  )
        COMBO(RBT         RTR    , &kp RBRC  )
        COMBO(LBT             LBP, &kp LT    )
        COMBO(RBT             RBP, &kp LT    )
        COMBO(LBT             LTP, &kp GT    )
        COMBO(RBT             RTP, &kp GT    )

        COMBO(    LTI LBM        , &kp QMARK )
        COMBO(    RTI RBM        , &kp QMARK )
        COMBO(    LBI LTM        , &kp COMMA )
        COMBO(    RBI RTM        , &kp COMMA )
        COMBO(        LTM LBR    , &kp MINUS )
        COMBO(        RTM RBR    , &kp MINUS )
        COMBO(        LBM LTR    , &kp FSLH  )
        COMBO(        RBM RTR    , &kp FSLH  )
        COMBO(            LTR LBP, &kp SQT   )
        COMBO(            RTR RBP, &kp SQT   )
        COMBO(            LBR LTP, &kp SEMI  )
        COMBO(            RBR RTP, &kp SEMI  )
        COMBO(LTT LTI LBM        , &kp EXCL  )
        COMBO(RTT RTI RBM        , &kp EXCL  )
        COMBO(LTT LBI LTM        , &kp DOT   )
        COMBO(RTT RBI RTM        , &kp DOT   )
        COMBO(LTT     LTM LBR    , &kp UNDER )
        COMBO(RTT     RTM RBR    , &kp UNDER )
        COMBO(LTT     LBM LTR    , &kp BSLH  )
        COMBO(RTT     RBM RTR    , &kp BSLH  )
        COMBO(LTT         LTR LBP, &kp DQT   )
        COMBO(RTT         RTR RBP, &kp DQT   )
        COMBO(LTT         LBR LTP, &kp COLON )
        COMBO(RTT         RBR RTP, &kp COLON )
        COMBO(LBT LTI LBI        , &kp LA(U) )
        COMBO(RBT RTI RBI        , &kp LA(U) )
        COMBO(LBT LBI LTM        , &kp TILDE )
        COMBO(RBT RBI RTM        , &kp TILDE )
        COMBO(LBT LBI     LTR    , &kp STAR  )
        COMBO(RBT RBI     RTR    , &kp STAR  )
        COMBO(LBT LTI     LBR    , &kp PLUS  )
        COMBO(RBT RTI     RBR    , &kp PLUS  )
        COMBO(LBT LTI         LBP, &kp AMPS  )
        COMBO(RBT RTI         RBP, &kp AMPS  )
        COMBO(LBT LBI         LTP, &kp DLLR  )
        COMBO(RBT RBI         RTP, &kp DLLR  )
        COMBO(LBT LTI         LTP, &kp HASH  )
        COMBO(RBT RTI         RTP, &kp HASH  )
        COMBO(LBT LBI         LBP, &kp AT    )
        COMBO(RBT RBI         RBP, &kp AT    )
        COMBO(LBT     LTM LBR    , &kp PRCNT )
        COMBO(RBT     RTM RBR    , &kp PRCNT )
        COMBO(LBT     LBM LTR    , &kp PIPE  )
        COMBO(RBT     RBM RTR    , &kp PIPE  )
        COMBO(LBT     LBM     LTP, &kp CARET )
        COMBO(RBT     RBM     RTP, &kp CARET )
        COMBO(LBT     LTM     LBP, &kp EQUAL )
        COMBO(RBT     RTM     RBP, &kp EQUAL )
        COMBO(LBT         LTR LBP, &kp GRAVE )
        COMBO(RBT         RTR RBP, &kp GRAVE )
        COMBO(LBT         LBR LTP, &kp LA(S) )
        COMBO(RBT         RBR RTP, &kp LA(S) )
        
        COMBO(    LBI LBM LBR    , &kp ENTER )
        COMBO(    RBI RBM RBR    , &kp ENTER )
        COMBO(    LTI LTM LTR    , &kp TAB   )
        COMBO(    RTI RTM RTR    , &kp TAB   )
        COMBO(LTT LBI LBM LBR    , &kp ESC   )
        COMBO(RTT RBI RBM RBR    , &kp ESC   )
        COMBO(LTT LTI LTM LTR    , &kp DEL   )
        COMBO(RTT RTI RTM RTR    , &kp DEL   )
        COMBO(LTT LBI LBM LBR    , &kp C_PP  )
        COMBO(RTT RBI RBM RBR    , &kp C_PP  )
        COMBO(LTT LTI LTM LTR    , &kp MUTE  )
        COMBO(RTT RTI RTM RTR    , &kp MUTE  )

        COMBO(    LTI LTM LBR    , &kp LEFT  )
        COMBO(    RBI RTM RTR    , &kp LEFT  )
        COMBO(    LBI LTM LTR    , &kp RIGHT )
        COMBO(    RTI RTM RBR    , &kp RIGHT )
        COMBO(    LBI LTM LBR    , &kp UP    )
        COMBO(    RBI RTM RBR    , &kp UP    )
        COMBO(    LTI LBM LTR    , &kp DOWN  )
        COMBO(    RTI RBM RTR    , &kp DOWN  )
        COMBO(LTT LTI LTM LBR    , &kp HOME  )
        COMBO(RTT RBI RTM RTR    , &kp HOME  )
        COMBO(LTT LBI LTM LTR    , &kp END   )
        COMBO(RTT RTI RTM RBR    , &kp END   )
        COMBO(LTT LBI LTM LBR    , &kp PG_UP )
        COMBO(RTT RBI RTM RBR    , &kp PG_UP )
        COMBO(LTT LTI LBM LTR    , &kp PG_DN )
        COMBO(RTT RTI RBM RTR    , &kp PG_DN )
        COMBO(LBT LTI LTM LBR    , &kp PREV  )
        COMBO(RBT RBI RTM RTR    , &kp PREV  )
        COMBO(LBT LBI LTM LTR    , &kp NEXT  )
        COMBO(RBT RTI RTM RBR    , &kp NEXT  )
        COMBO(LBT LBI LTM LBR    , &kp VOLUP )
        COMBO(RBT RBI RTM RBR    , &kp VOLUP )
        COMBO(LBT LTI LBM LTR    , &kp VOLDN )
        COMBO(RBT RTI RBM RTR    , &kp VOLDN )

        COMBO(LBI LTI, &kp LSHFT)
        COMBO(RBI RTI, &kp LSHFT)
        COMBO(LBM LTM, &kp LCTRL)
        COMBO(RBM RTM, &kp LCTRL)
        COMBO(LBR LTR, &kp LALT )
        COMBO(RBR RTR, &kp LALT )
        COMBO(LBP LTP, &kp LMETA)
        COMBO(RBP RTP, &kp LMETA)
  };

  behaviors {
    hm: hold_mod {
      compatible = "zmk,behavior-hold-tap";
      label = "HOLD_MOD";
      #binding-cells = <2>;
      flavor = "tap-preferred";
      tapping-term-ms = <150>;
      bindings = <&kp>, <&kp>;
    };
    lm: layer_mod {
      compatible = "zmk,behavior-hold-tap";
      label = "LAYER_MOD";
      #binding-cells = <2>;
      flavor = "tap-preferred";
      tapping-term-ms = <150>;
      bindings = <&mo>, <&kp>;
    }; 
    rm: repeat_mod {
      compatible = "zmk,behavior-hold-tap";
      label = "REPEAT_MOD";
      #binding-cells = <2>;
      flavor = "tap-preferred";
      tapping-term-ms = <150>;
      bindings = <&mo>, <&key_repeat>;
    };
  };

  keymap {
    compatible = "zmk,keymap";

    default_layer {
      bindings = <
        KEY B      KEY B      UML F      ESZ P      NON        &to L_TAI  KEY L      KEY U      KEY Y      &to L_GAM
        RMM A      RMA R      RMC S      RMS T      FTA G      FRT M      RMS N      RMC E      RMA I      RMM O
        UDO Z      KUT W      CPY C      PST D      SAV V      FES K      KEY H      KEY J      KEY X      KEY Q
                                         LM1 CMMA   KEY SPC    LM3        LM2 DOT
      >;
    };
    left_layer {
        bindings = <
        KEY N7     KEY N7     KEY N8     KEY N9     NON        NON        KEY BSLH   KEY PRCNT  KEY CARET  NON
        RMM N0     RMA N4     RMC N5     RMS N6     KEY PLUS   KEY ASTRK  RMS LPAR   RMC RPAR   RMA LBRC   RMM RBRC
        KEY EQUAL  KEY N1     KEY N2     KEY N3     KEY MINUS  KEY SLASH  KEY LBKT   KEY RBKT   KEY LT     KEY GT
                                         NON        NON        KEY DEL    KEY COLON
        >;
    };
    right_layer {
        bindings = <
        KEY TILDE  KEY TILDE  KEY AT     KEY HASH   NON        NON        KEY HOME   KEY UP     KEY END    NON
        RMM UNDER  RMA GRAVE  RMC APOS   RMS DQT    KEY EXCL   KEY PG_UP  KEY LEFT   KEY DOWN   KEY RIGHT  NON
        NON        KEY DLLR   KEY AMPS   KEY PIPE   KEY QMARK  KEY PG_DN  NON        NON        NON        NON
                                         KEY SEMI   KEY BKSP   NON        NON
        >;
    };
    third_layer {
        bindings = <
        KEY F7     KEY F7     KEY F8     KEY F9     NON        NON        KEY VOLDN  KEY MUTE  KEY VOLUP   NON
        RMM F12    RMA F4     RMC F5     RMS F6     KEY F10    BLU BTCLR  RMS PREV   RMC C_PP   RMA NEXT   RMM 0
        NON        KEY F1     KEY F2     KEY F3     KEY F11    NON        BLU BT1    BLU BT2    BLU BT3    BLU BT4
                                         NON        NON        NON        NON
        >;
    };

    gaming_layer {
        bindings = <
        KEY N1     KEY N2     KEY N3     KEY N4     KEY T      &to L_DEF  NON        NON        NON        NON        
        KEY Q      KEY W      KEY E      KEY R      KEY F      NON        NON        NON        NON        NON
        KEY LC(N6) KEY V      KEY G      KEY D      KEY B      NON        NON        NON        NON        NON
                                         KEY TAB    KEY SPC    NON        NON
      >;
    }; 

    taipo_layer {
      bindings = <
        NON NON NON NON NON DEF NON NON NON NON 
        NON NON NON NON NON NON NON NON NON NON 
        NON NON NON NON NON NON NON NON NON NON 
                    NON NON NON NON   
      >;
    };   
  };
};
